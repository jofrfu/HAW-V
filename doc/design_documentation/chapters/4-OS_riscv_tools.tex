% File		: 	main.tex
% Created by:	Talal Tabia
% Created at :	04.12.17 11:00
% Authors	:	Talal Tabia

\chapter{OS Riscv Tools}

\section{Operating System}

To compile and test a linux operating system based on riscv32i, we need to install some tools to get started. 

\section{Packages needed}

\subsection{Ubuntu}
\begin{verbatim}
     $ sudo apt-get install autoconf automake autotools-dev curl 
      device-tree-compiler libmpc-dev libmpfr-dev libgmp-dev 
      libusb-1.0-0-dev gawk build-essential bison flex texinfo 
      gperf libtool patchutils bc zlib1g-dev pkg-config git

\end{verbatim}

\subsection{Fedora}

\begin{verbatim}
    $ sudo dnf install autoconf automake @development-tools curl
     dtc libmpc-devel mpfr-devel gmp-devel gawk build-essential 
     bison flex texinfo gperf libtool patchutils bc zlib-devel
\end{verbatim}

\section{Installing the toolchain}

Choose a place in your hard drive with big expanse space, and let's call that \$TOP.
Change to the directory you want to install in, and then set the \$TOP environment variable accordingly:

\begin{verbatim}
    $ export TOP=$(pwd)
\end{verbatim}

\newpage 

\subsection{Toolchain components}

\begin{itemize}
\item riscv-gnu-toolchain, a RISC-V cross-compiler
\item riscv-pk, a proxy kernel that services system calls generated by code built \\and linked with RISC-V Newlist port (this does not apply to Linux, as it handles the system calls)
\item riscv-tests, a set of assembly tests and benchmarks
\item others,...
\end{itemize}

\subsection{Obtaining and compiling the sources}
Change directory and clone the tools from the riscv-tools GitHub repository:
\begin{verbatim}
   $ cd $TOP
   $ git clone https://gitub.com/riscv/riscv-tools.git
\end{verbatim}

Updating submodules
\begin{verbatim}
   $ cd $TOP/riscv-tools
   $ git submodule update --init --recursive
\end{verbatim}

Before we start installation, we need to set the \$RISCV environment variable. \\The variable is used throughout the build script process to identify where to install the new tools. \\(This value is used as the argument to the --prefix configuration switch.)

\begin{verbatim}
   $ export RISCV=$TOP/riscv
\end{verbatim}

Add bin folder to \$PATH variable

\begin{verbatim}
   $ export PATH=$PATH:$RISCV/bin
\end{verbatim}

Now, we can run the build script.

\begin{verbatim}
   $ ./build.sh
\end{verbatim}

\subsection{Testing your toolchain}

Now when you installed the toolchain, we can start by testing it with a simple ``Hello world'' programm.
Exit the riscv-tools directory and write you ``Hello world'' programm.

\begin{verbatim}
   $ cd $TOP
   $ echo -e '#include <stdio.h>\n int main(void) { printf("Hello world!\\n");
     return 0; }' > hello.c
\end{verbatim}

\newpage

Then, build your programm with riscv32-unknown-elf-gcc.

\begin{verbatim}
   $ cd $TOP
   $ riscv-32-unknow-elf-gcc -o hello hello.c
\end{verbatim}

The ``Hello wolrd'' programm involves a system call, which couldn't be handled by out x86 system. \\We'll have to run it within the proxy kernel 'pk', this can be run via spike, the RISC-V architectural simulator. Run your ``hello wolrd'' programm via spike like so:

\begin{verbatim}
   $ spike pk hello
\end{verbatim}
